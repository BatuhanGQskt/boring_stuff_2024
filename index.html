<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Optimizer</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="container my-5">
    <h1 class="text-center text-primary mb-4">EfficientBrains</h1>
    <p class="text-center mb-4">
      Enter the file path of your code and click "Analyze" to optimize its functions.
    </p>
    <form id="path-form" class="text-center mb-4">
      <div class="mb-3">
        <input type="text" id="file-path-input" class="form-control w-50 mx-auto" placeholder="Enter file path" required>
      </div>
      <button type="submit" class="btn btn-primary btn-lg">Analyze</button>
    </form>
    <div id="functions-list" class="card shadow p-4 mb-4" style="display: none;">
      <h2 class="card-title mb-4 text-center">Select Function to Optimize</h2>
      <form id="functions-form">
        <!-- Function radio buttons will be inserted dynamically -->
      </form>
    </div>
    <div id="output-container" class="container mt-5"></div>
  </div>

  <!-- Bootstrap JS and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const pathForm = document.getElementById("path-form");
    const filePathInput = document.getElementById("file-path-input");
    const functionsList = document.getElementById("functions-list");
    const functionsForm = document.getElementById("functions-form");
    const outputContainer = document.getElementById("output-container");

    let filePath = "";

    // Handle file path submission and analysis
    pathForm.addEventListener("submit", async (event) => {
      event.preventDefault();

      filePath = filePathInput.value.trim();
      if (!filePath) {
        alert("Please enter a valid file path!");
        return;
      }

      try {
        // Show a loading message
        outputContainer.innerHTML = "<p>Analyzing your code...</p>";

        const response = await fetch("http://127.0.0.1:5000/upload-code", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ file_path: filePath }),
        });

        if (!response.ok) {
          throw new Error(`Error: ${response.statusText}`);
        }

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        displayFunctions(result.functions);
        outputContainer.innerHTML = ""; // Clear the loading message
      } catch (error) {
        outputContainer.innerHTML = `<p class="text-danger">${error.message}</p>`;
      }
    });

    // Display available functions
    function displayFunctions(functions) {
      if (functions.length === 0) {
        outputContainer.innerHTML = "<p>No functions found in the code.</p>";
        return;
      }

      functionsList.style.display = "block";
      functionsForm.innerHTML = ""; // Clear previous content

      // Add a radio button for each function
      functions.forEach((func, index) => {
        const radioDiv = document.createElement("div");
        radioDiv.className = "form-check mb-2";

        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "function"; // Shared name for all radio buttons
        radio.value = func;
        radio.id = `function-${index}`; // Unique ID for each radio button
        radio.className = "form-check-input";

        const label = document.createElement("label");
        label.htmlFor = `function-${index}`;
        label.textContent = func;
        label.className = "form-check-label";

        radioDiv.appendChild(radio);
        radioDiv.appendChild(label);
        functionsForm.appendChild(radioDiv);
      });

      const optimizeButton = document.createElement("button");
      optimizeButton.type = "submit";
      optimizeButton.textContent = "Optimize Selected Function";
      optimizeButton.className = "btn btn-primary mt-3";

      functionsForm.appendChild(optimizeButton);
    }

    // Handle function optimization
    functionsForm.addEventListener("submit", async (event) => {
      event.preventDefault();

      const selectedFunction = functionsForm.elements["function"].value;

      if (!selectedFunction) {
        alert("Please select a function to optimize.");
        return;
      }

      try {
        outputContainer.innerHTML = "<p>Optimizing selected function...</p>";

        const response = await fetch("http://127.0.0.1:5000/optimize-code", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            file_path: filePath,
            selected_functions: [selectedFunction],
          }),
        });

        if (!response.ok) {
          throw new Error(`Error: ${response.statusText}`);
        }

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        displayOptimizedFunctions(result.function_changes);
      } catch (error) {
        outputContainer.innerHTML = `<p class="text-danger">${error.message}</p>`;
      }
    });

    function displayOptimizedFunctions(functionChanges) {
  outputContainer.innerHTML = ""; // Clear previous content

  for (const [funcName, changes] of Object.entries(functionChanges)) {
    const row = document.createElement("div");
    row.className = "row mb-4";

    const funcHeading = document.createElement("h3");
    funcHeading.className = "text-center mb-3";
    funcHeading.textContent = `Function: ${funcName}`;
    outputContainer.appendChild(funcHeading);

    const originalCol = document.createElement("div");
    originalCol.className = "col-md-6";
    originalCol.innerHTML = `
      <div class="card shadow">
        <div class="card-header bg-secondary text-white">
          Original
        </div>
        <div class="card-body">
          <pre class="bg-light p-3 rounded">${changes.original}</pre>
        </div>
      </div>
    `;

    const optimizedCol = document.createElement("div");
    optimizedCol.className = "col-md-6";
    optimizedCol.innerHTML = `
      <div class="card shadow d-flex flex-column">
        <div class="card-header bg-success text-white">
          Optimized
        </div>
        <div class="card-body flex-grow-1">
          <pre class="bg-light p-3 rounded">${changes.optimized}</pre>
        </div>
        <div class="card-footer text-end">
          <button class="btn btn-success accept-btn" 
            data-func="${funcName}" 
            data-start="${changes.start_line}" 
            data-end="${changes.end_line}" 
            data-path="${changes.file_path}">
            +
          </button>
        </div>
      </div>
    `;

    row.appendChild(originalCol);
    row.appendChild(optimizedCol);
    outputContainer.appendChild(row);
  }

  const acceptButtons = document.querySelectorAll(".accept-btn");
  acceptButtons.forEach((button) => {
    button.addEventListener("click", async (event) => {
      const funcName = event.target.getAttribute("data-func");
      const startLine = event.target.getAttribute("data-start");
      const endLine = event.target.getAttribute("data-end");
      const filePath = event.target.getAttribute("data-path");
      const optimizedCode = event.target
        .closest(".card")
        .querySelector("pre").textContent;

      try {
        const response = await fetch("http://127.0.0.1:5000/accept-optimized-code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            func_name: funcName,
            file_path: filePath,
            start_line: startLine,
            end_line: endLine,
            optimized_code: optimizedCode,
          }),
        });

        if (!response.ok) {
          throw new Error(`Error: ${response.statusText}`);
        }

        const result = await response.json();
        alert(`Function "${funcName}" has been updated successfully!`);
      } catch (error) {
        console.error(error);
        alert(`Failed to update function "${funcName}": ${error.message}`);
      }
    });
  });
}


  </script>
</body>
</html>
